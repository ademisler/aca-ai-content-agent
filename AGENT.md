# AGENT.md - ACA - AI Content Agent (Definitive Developer's Guide)

**Version: 1.2**
**Last Updated:** 2025-07-25

This document provides a definitive, highly-detailed technical overview of the "ACA - AI Content Agent" WordPress plugin. It is structured to guide developers and AI tools from high-level concepts down to specific implementation details, workflows, and known issues.

## 1. Core Concepts (The Plugin's Domain)

To understand the code, one must first understand the core concepts of the plugin:

-   **Style Guide**: A text-based description of a website's writing style (tone, voice, sentence structure). It is generated by the **Engine** by analyzing existing posts and is used as a system-level instruction for the Gemini API to ensure brand consistency.
-   **Idea**: A potential article title. Ideas are generated by the **Engine** based on existing content or Google Search Console queries. They are stored in a custom database table and have a status (`pending`, `drafted`, `rejected`).
-   **Draft**: A full WordPress post with a `draft` status. It is created by the **Engine** from an **Idea** and is the primary output of the plugin.
-   **Enrichment**: The process of adding value to a newly created **Draft**. This includes adding internal links, a featured image, tags, and a meta description. This is handled by the **Engine** after the initial draft is created.
-   **Automation Level**: The user-configured mode of operation (`manual`, `semi-auto`, `full-auto`) that dictates how the **Cron Controller** triggers the **Engine** to create Ideas and Drafts.

## 2. System Architecture: A Layered Model

The plugin uses a standard, layered architecture to separate concerns:

-   **1. Presentation Layer (UI)**: Renders the admin interface. This is the primary role of `class-aca-dashboard.php` and the `render_*` methods in `class-aca-admin.php`, supported by the assets in `/admin`.
-   **2. Controller/Dispatcher Layer (AJAX/Cron)**: The entry point for all dynamic requests. It validates requests and delegates them to the business logic layer. This is the role of `handle_ajax_*` methods in `class-aca-admin.php` and the `run_*` methods in `class-aca-cron.php`.
-   **3. Business Logic Layer (Engine)**: The plugin's core. `includes/class-aca.php` (`ACA_AI_Content_Agent_Engine`) contains all the complex logic for content analysis, prompt engineering, and post creation.
-   **4. Service/Gateway Layer**: Manages all external API communications. `includes/api.php` (for Gemini) and `includes/licensing.php` (for Gumroad) abstract these external calls.
-   **5. Data Access Layer**: Handles all database interactions. This is not a formal class but a collection of direct `$wpdb` calls and WordPress Options API functions (`get_option`, `update_option`, `set_transient`) spread throughout the Engine and Controller layers.

## 3. File-by-File Functional Breakdown

-   **`aca.php`**: The main plugin bootstrap file; loads all dependencies, initializes classes, and handles activation/deactivation hooks.
-   **`uninstall.php`**: Contains the code to completely remove all plugin data (tables, options, roles) upon uninstallation.
-   **`readme.txt`**: The user-facing plugin description for the WordPress Plugin Directory.
-   **`composer.json` / `composer.lock`**: Defines and locks the PHP dependency on `woocommerce/action-scheduler`.
-   **`.gitignore`**: Specifies files and directories for Git to ignore.
-   **`AGENT.md`**: This file.
-   **`/admin/css/aca-admin.css`**: Contains all custom CSS for styling the plugin's admin pages.
-   **`/admin/js/aca-admin.js`**: Contains all client-side JavaScript for handling user interactions and making AJAX requests.
-   **`/includes/api.php`**: A dedicated gateway that handles all API communication with Google Gemini, including request/response logic and key encryption/decryption.
-   **`/includes/class-aca-admin.php`**: The primary controller for the admin panel; registers settings, creates menu pages, and handles all incoming AJAX requests.
-   **`/includes/class-aca-cron.php`**: Manages all scheduled tasks (cron jobs) using the Action Scheduler library.
-   **`/includes/class-aca-dashboard.php`**: Responsible for rendering the main dashboard UI.
-   **`/includes/class-aca-onboarding.php`**: Manages the one-time setup wizard for new users.
-   **`/includes/class-aca-privacy.php`**: Integrates with the WordPress privacy tools for exporting and erasing user data.
-   **`/includes/class-aca.php`**: The core **Engine** of the plugin, containing all the business logic.
-   **`/includes/licensing.php`**: Handles all logic related to validating the Pro version license key via the Gumroad API.
-   **`/languages/aca.pot`**: The main translation template file.
-   **`index.php` (in all subdirectories)**: Standard WordPress security files to prevent directory listing.

## 4. Dynamic Workflows & Data Flow

### 4.1. User-Triggered: Idea to Draft
This is the primary user-facing workflow.

```
[User clicks "Write Draft" in UI]
       |
       v
[admin/js/aca-admin.js] --(AJAX Request: action='aca_ai_content_agent_write_draft', id=123)--> [WordPress Core]
       |
       v
[class-aca-admin.php::handle_ajax_write_draft()]
       | 1. Verifies nonce & capabilities.
       | 2. Calls Engine with sanitized idea ID.
       v
[class-aca.php::write_post_draft(123)]
       | 1. Reads idea from database.
       | 2. Fetches style guide from options.
       | 3. Calls API Gateway with a constructed prompt.
       v
[api.php::aca_ai_content_agent_call_gemini_api(prompt)]
       | 1. Decrypts API key.
       | 2. Makes external call via `wp_remote_post()`.
       | 3. Returns API response (JSON string) or WP_Error.
       v
[Back in class-aca.php::write_post_draft()]
       | 1. Parses JSON response.
       | 2. Creates post via `wp_insert_post()`.
       | 3. Calls `enrich_draft()` to add links, images, etc.
       | 4. Updates idea status in the database.
       | 5. Returns success array {message, edit_link}.
       v
[Back in class-aca-admin.php::handle_ajax_write_draft()]
       |
       v
[Sends JSON success response back to browser]
```

### 4.2. Automated: Scheduled Idea Generation
This workflow runs in the background for semi-automatic and fully-automatic modes.

1.  **Scheduling**: `class-aca-cron.php::schedule_events()` registers a recurring action `aca_ai_content_agent_run_main_automation` with Action Scheduler.
2.  **Execution**: Action Scheduler triggers the hook at the scheduled time.
3.  **Callback**: `class-aca-cron.php::run_main_automation()` is executed.
4.  **Logic**: It checks the `working_mode` option. If not `manual`, it calls `ACA_AI_Content_Agent_Engine::generate_ideas()`.
5.  **Engine**: The engine gets existing post titles, builds a prompt, calls the Gemini API via the gateway, parses the response, and inserts the new ideas into the `..._ideas` table with a `pending` status.

## 5. Code Analysis & Known Issues

-   **Incomplete Data Cleanup on Uninstall (FIXED)**:
    -   **Location**: `uninstall.php`.
    -   **Issue**: The uninstall script was deleting plugin-specific options from the `wp_options` table but was not deleting the transients (temporary cached data) created by the plugin, leaving orphaned data in the database.
    -   **Status**: **Fixed**. The script now includes additional queries to properly remove all related transients upon uninstallation.
-   **Missing Deactivation Hook (FIXED)**:
    -   **Location**: `aca.php`.
    -   **Issue**: The plugin had a deactivation function (`aca_ai_content_agent_deactivate`) but it was never registered with `register_deactivation_hook`. This meant that scheduled actions and custom capabilities were not being cleaned up when the plugin was deactivated.
    -   **Status**: **Fixed**. The deactivation hook has been correctly registered.
-   **Insecure Activation Redirect (FIXED)**:
    -   **Location**: `aca.php` in `ACA_Bootstrap::activate`.
    -   **Issue**: The post-activation redirect logic was handled directly within the activation hook and checked a `$_GET` variable without a nonce, creating a minor open redirect vulnerability.
    -   **Status**: **Fixed**. The redirect logic was moved to a new handler hooked into `admin_init`, which is a safer and more standard way to handle post-activation redirects.
-   **DB Schema Mismatch in Clusters (FIXED)**:
    -   **Location**: `aca.php` in `ACA_Bootstrap::create_custom_tables`.
    -   **Issue**: The `..._cluster_items` database table was created with a column named `subtopic`, but the rest of the code expected this column to be `subtopic_title`.
    -   **Status**: **Fixed**. The table schema has been corrected to use `subtopic_title`.
-   **CSRF Vulnerability in License Handling (FIXED)**:
    -   **Location**: `includes/class-aca-admin.php` in method `handle_ajax_validate_license`.
    -   **Issue**: The method was suppressing a `WordPress.Security.NonceVerification.Recommended` warning, potentially allowing a Cross-Site Request Forgery (CSRF) attack. An attacker could have tricked an administrator into activating a different license key.
    -   **Status**: **Fixed**. The unnecessary `phpcs:ignore` has been removed, and proper nonce verification is now enforced for all AJAX requests, including license validation.
-   **Incomplete Transaction Rollback (FIXED)**:
    -   **Location**: `includes/class-aca.php` in method `write_post_draft`.
    -   **Issue**: If updating the idea's status failed in the database, the transaction was rolled back, but the function proceeded to the enrichment steps instead of stopping.
    -   **Status**: **Fixed**. The function now correctly exits after a failed database update and rollback.
-   **Incorrect File Type Check (FIXED)**:
    -   **Location**: `includes/class-aca.php` in method `maybe_set_featured_image`.
    -   **Issue**: The `wp_check_filetype` function was incorrectly called with a URL (`$url`) instead of the local temporary file path (`$tmp`), causing the file type validation to fail.
    -   **Status**: **Fixed**. The function now correctly uses the temporary file path for validation.
-   **Faulty Cron Rescheduling (FIXED)**:
    -   **Location**: `includes/class-aca-cron.php` in method `schedule_events`.
    -   **Issue**: The method cleared and rescheduled all cron jobs every time any plugin setting was updated. This caused scheduled tasks like the monthly API counter reset to be postponed incorrectly.
    -   **Status**: **Fixed**. The logic has been updated to only unschedule or reschedule jobs when their specific controlling setting (e.g., frequency, mode) is changed, preventing unintended shifts in schedule.
-   **Redundant Logic in Automation (FIXED)**:
    -   **Location**: `includes/class-aca-cron.php` in method `run_main_automation`.
    -   **Issue**: In `full-auto` mode, the code was unnecessarily using `array_slice` to limit the number of ideas to process, even though the `generate_ideas` function already respects this limit.
    -   **Status**: **Fixed**. The redundant `array_slice` call has been removed to simplify the code.
-   **Disruptive Page Reload on Idea Generation (FIXED)**:
    -   **Location**: `admin/js/aca-admin.js`.
    -   **Issue**: After generating new ideas, the page would automatically reload, causing a poor user experience by losing the user's scroll position and context.
    -   **Status**: **Fixed**. The `location.reload()` call was removed. The AJAX handler now returns the HTML for the new ideas, which are dynamically inserted into the list on the frontend.
-   **Unclear Feedback State in UI (FIXED)**:
    -   **Location**: `admin/js/aca-admin.js`.
    -   **Issue**: Clicking a feedback button (ğŸ‘/ğŸ‘) only changed its opacity, which did not clearly indicate that the action was successfully processed and that no further action was needed.
    -   **Status**: **Fixed**. After clicking, both feedback buttons for an idea are now disabled and styled with reduced opacity to provide clear visual confirmation.

## 6. How to Extend the Plugin

### Adding a New Setting
1.  **Add the Field**: In `class-aca-admin.php::register_settings()`, add a new `add_settings_field()` call and a corresponding `render_*_field()` method to display the HTML.
2.  **Sanitize the Input**: In `class-aca-admin.php::sanitize_options()`, add the new setting's key to the `$new_input` array from the `$input` array and applying the correct sanitization function (e.g., `sanitize_text_field`, `absint`).
3.  **Use the Setting**: Access the new setting from the global options array: `$options = get_option('aca_ai_content_agent_options'); $my_setting = $options['new_setting_key'];`

### Adding a New Enrichment Step
1.  **Create the Method**: In `class-aca.php`, create a new public or private static method, e.g., `add_author_bio($post_id)`.
2.  **Hook into Enrichment**: In `class-aca.php::enrich_draft()`, add a call to your new method: `self::add_author_bio($post_id)`.

## 7. Proposed New Directory Structure

This structure will make the codebase much easier to navigate, maintain, and test.

```
/includes/
â”œâ”€â”€ admin/
â”‚   â”œâ”€â”€ class-aca-admin-menu.php
â”‚   â”œâ”€â”€ class-aca-admin-settings.php
â”‚   â”œâ”€â”€ class-aca-ajax-handler.php
â”‚   â”œâ”€â”€ class-aca-admin-views.php
â”‚   â”œâ”€â”€ class-aca-admin-notices.php
â”‚   â””â”€â”€ class-aca-onboarding.php
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ class-aca-content-generator-service.php
â”‚   â”œâ”€â”€ class-aca-content-enrichment-service.php
â”‚   â”œâ”€â”€ class-aca-style-guide-service.php
â”‚   â””â”€â”€ class-aca-licensing-service.php
â”œâ”€â”€ clients/
â”‚   â”œâ”€â”€ class-aca-gemini-client.php
â”‚   â”œâ”€â”€ class-aca-gsc-client.php
â”‚   â”œâ”€â”€ class-aca-pexels-client.php
â”‚   â”œâ”€â”€ class-aca-openai-client.php
â”‚   â””â”€â”€ class-aca-copyscape-client.php
â”œâ”€â”€ integrations/
â”‚   â”œâ”€â”€ class-aca-post-integration.php
â”‚   â””â”€â”€ class-aca-privacy.php
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ class-aca-crypto-util.php
â”‚   â””â”€â”€ class-aca-plugin-helper.php
â”œâ”€â”€ class-aca-lifecycle.php
â”œâ”€â”€ class-aca-cron.php
â””â”€â”€ class-aca-main.php (The main plugin controller)
```